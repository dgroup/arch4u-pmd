<?xml version="1.0"?>
<ruleset name="arch4u-micrometer"
         xmlns="http://pmd.sf.net/ruleset/1.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sf.net/ruleset/1.0.0 http://pmd.sf.net/ruleset_xml_schema.xsd"
         xsi:noNamespaceSchemaLocation="http://pmd.sf.net/ruleset_xml_schema.xsd">
  <description>arch4u micrometer rules</description>

  <rule name="MissingMandatoryAnnotation"
        since="0.1.0"
        language="java"
        message="TBD"
        class="io.github.dgroup.arch4u.pmd.MissingMandatoryAnnotation">
    <description>
      TBD
    </description>
    <priority>3</priority>
    <properties>
      <property name="restAnnotations" type="List[String]" delimiter="|"
                description="List of the REST endpoint method annotations"
                value="org.springframework.web.bind.annotation.GetMapping
|org.springframework.web.bind.annotation.DeleteMapping
|org.springframework.web.bind.annotation.PatchMapping
|org.springframework.web.bind.annotation.PostMapping
|org.springframework.web.bind.annotation.PutMapping
|org.springframework.web.bind.annotation.RequestMapping"/>
      <property name="mandatoryAnnotations" type="List[String]" delimiter="|"
                description="List of the mandatory metric method annotations"
                value="io.micrometer.core.annotation.Timed"/>
    </properties>
    <example>
      <![CDATA[
      import org.springframework.web.bind.annotation.RestController;
      import org.springframework.web.bind.annotation.GetMapping;
      import io.micrometer.core.annotation.Timed;

      @RestController
      public class MyTypicalRestController {

         @GetMapping("/foo")    //violation
         public Foo getFoo() {
            //...
         }

         @Timed
         @GetMapping("/bar")
         public Foo getBar() {
            //...
         }
      }
      ]]>
    </example>
  </rule>

  <rule name="UseConstantForMetricAnnotation"
        since="0.1.0"
        language="java"
        message="TBD"
        class="net.sourceforge.pmd.lang.rule.XPathRule">
    <description>
      TBD
    </description>
    <priority>3</priority>
    <properties>
      <property name="metricAnnotations" type="List[String]" delimiter="|"
                description="List of the metric annotations"
                value="io.micrometer.core.annotation.Timed"/>
      <property name="version" value="2.0"/>
      <property name="xpath">
        <value>
          <![CDATA[
          //Annotation[some $annotation in $metricAnnotations satisfies pmd-java:typeIsExactly($annotation)]
          [
          SingleMemberAnnotation/MemberValue/PrimaryExpression/PrimaryPrefix/Literal
          or
          NormalAnnotation/MemberValuePairs/MemberValuePair[@Image='value']/MemberValue/PrimaryExpression/PrimaryPrefix/Literal
          ]
          ]]>
        </value>
      </property>
    </properties>
    <example>
      <![CDATA[
      import io.micrometer.core.annotation.Timed;

      public class Foo {

         @Timed("value")
         public void bar() {
         }

         @Timed(value="value")
         public void baz() {
         }
      }
      ]]>
    </example>
  </rule>
</ruleset>
